<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Генератор комплектов — слушатель</title>
<style>
:root{--bg:#0b1020;--card:#111a33;--ink:#e9eefc;--muted:#a7b3d6;--accent:#7aa2ff;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070b17,#0b1020);color:var(--ink)}
header{padding:18px 16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:rgba(11,16,32,.92);backdrop-filter: blur(8px);z-index:10}
h1{margin:0;font-size:18px}
small{color:var(--muted)}
.container{max-width:1180px;margin:0 auto;padding:16px;display:grid;gap:14px}
.card{background:rgba(17,26,51,.75);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
input,select,button{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--ink);padding:10px 10px;font-size:14px}
input{min-width:160px}
button{cursor:pointer;background:linear-gradient(180deg,rgba(122,162,255,.25),rgba(122,162,255,.12));border-color:rgba(122,162,255,.35)}
button.secondary{background:rgba(255,255,255,.06)}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px}
.note{color:var(--muted);font-size:13px;line-height:1.4}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:980px){.grid2{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 8px;text-align:left;vertical-align:top}
th{color:#cfe0ff;font-weight:600}
hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:12px 0}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
.kpi b{display:block;font-size:16px}
svg{max-width:100%}
.variant-grid{display:grid;grid-template-columns:repeat(10, minmax(0,1fr));gap:6px;margin-top:10px}
@media(max-width:900px){.variant-grid{grid-template-columns:repeat(6,minmax(0,1fr));}}
.variant-btn{padding:8px 0;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--ink);cursor:pointer}
.variant-btn.active{border-color:rgba(122,162,255,.7);background:rgba(122,162,255,.18)}

/* ===== ПЕЧАТЬ ===== */
.print-only{display:none}
@media print{
  @page{margin:14mm;}
  header, .no-print, #variantGrid, #variantTop, #btnKit, #btnCSV, #btnPrint{display:none !important;}
  .print-only{display:block !important;}
  body{background:#fff !important;color:#000 !important;}
  .container{max-width:none !important;padding:0 !important;}
  .card{
    background:#fff !important;
    color:#000 !important;
    box-shadow:none !important;
    border:1px solid #bbb !important;
    break-inside:avoid;
    page-break-inside:avoid;
  }
  th,td{border-bottom:1px solid #ddd !important;}
  th{color:#000 !important;}
}
</style>
</head>
<body>
<header>
  <div class="container" style="padding:0 16px;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div>
        <h1>Генератор комплектов — слушатель</h1>
        <small>Варианты 1–30. Слушатель: без решения. (HTML офлайн/Pages)</small>
      </div>
      <div><span class="badge">Режим слушателя</span></div>
    </div>
  </div>
</header>

<div class="container">

  <!-- Печатная шапка (видна только при печати) -->
  <div class="print-only" style="margin:0 0 10px 0;">
    <h2 style="margin:0 0 4px 0; font-size:16pt;">
      Комплект исходных данных — вариант № <span id="printVar">1</span>
    </h2>
    <div style="font-size:11pt;">Дата печати: <span id="printDate"></span></div>
    <hr/>
  </div>

  <!-- Карточка управления (в печать не попадает) -->
  <div class="card no-print">
    <div class="row" style="justify-content:space-between;align-items:flex-end;">
      <div class="note" style="max-width:740px;">
        Выберите <b>номер варианта (1–30)</b>. После выбора формируется <b>единый комплект исходных данных</b> для трёх задач:
        (1) временной ряд; (2) распределение вызовов по 100 участкам; (3) распределения времён реагирования по интервалам.
      </div>
      <div class="row">
        <div>
          <label>Номер варианта</label>
          <select id="variantTop"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnKit" type="button">Применить вариант</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="secondary" id="btnCSV" type="button">Скачать все CSV</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="secondary" id="btnPrint" type="button">Печать / PDF</button>
        </div>
      </div>
    </div>

    <div class="variant-grid" id="variantGrid"></div>

    <div class="kpi" style="margin-top:10px;">
      <div class="pill"><small>Текущий вариант</small><b id="curVar">1</b></div>
      <div class="pill"><small>Подсказка</small><b>нажмите номер или выберите в списке</b></div>
    </div>

    <div class="note" style="margin-top:8px;">
      Вариант определяет: (а) ряд пожаров (за 3 года по дням недели); (б) число выездов и распределение по участкам;
      (в) параметры генерации 4 времён (T₁≤1 мин, T₂≤1 мин, T₃≤10 мин) и их интервальные частоты.
    </div>
  </div>

  <div class="card" id="sec1">
    <h3 style="margin:0 0 8px 0;">Раздел 1. Временной ряд (пожары по дням недели за 3 года)</h3>
    <div id="s1out"></div>
    <div id="s1teacher" style="margin-top:12px;display:none;">
      <div class="grid2">
        <div>
          <h4 style="margin:0 0 6px 0;">Автокорреляция (до лага 10)</h4>
          <div id="s1acfTable"></div>
        </div>
        <div>
          <h4 style="margin:0 0 6px 0;">Коррелограмма</h4>
          <div id="s1acfPlot"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="sec2">
    <h3 style="margin:0 0 8px 0;">Раздел 2. Вызовы по территории (100 участков, сетка 10×10)</h3>
    <div class="kpi" id="s2kpi"></div>
    <hr/>
    <div class="grid2">
      <div>
        <h4 style="margin:0 0 6px 0;">Матрица 10×10 (число вызовов на участке)</h4>
        <div id="s2grid"></div>
      </div>
      <div>
        <h4 style="margin:0 0 6px 0;">Эмпирические частоты (число участков с k вызовами)</h4>
        <div id="s2freq"></div>
        <div id="s2teacher" style="margin-top:12px;display:none;">
          <h4 style="margin:0 0 6px 0;">Проверка χ² Пирсона (преподаватель)</h4>
          <div id="s2chi"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="sec3">
    <h3 style="margin:0 0 8px 0;">Раздел 3. Времена реагирования (4 распределения по интервалам, N=100)</h3>
    <div class="kpi" id="s3kpi"></div>
    <hr/>
    <div id="s3out"></div>
    <div id="s3teacher" style="margin-top:12px;display:none;">
      <h4 style="margin:0 0 6px 0;">Подбор порядка Эрланга по χ² (преподаватель)</h4>
      <div id="s3summary"></div>
      <div style="margin-top:10px;">
        <h4 style="margin:0 0 6px 0;">χ² по кандидатам k=1..4</h4>
        <div id="s3chiTables"></div>
      </div>
      <div class="note" style="margin-top:8px;">
        Ключ для преподавателя: генерация построена так, что истинные порядки: T₀→k=1, T₁→k=2, T₂→k=3, T₃→k=4.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="note">
      <b>Экспорт:</b> «Скачать все CSV» выгружает 4 файла: Раздел 1 (ряд), Раздел 2 (матрица 10×10 и частоты), Раздел 3 (Oᵢ для T₀..T₃).
    </div>
  </div>
</div>

<script>
/* ===== Раздел 1: базовый ряд + детерминированное варьирование по варианту ===== */
const SECTION1_BASE = [
  {year:2019,dow:"пн",label:"2019 пн",fires:65112},
  {year:2019,dow:"вт",label:"2019 вт",fires:65031},
  {year:2019,dow:"ср",label:"2019 ср",fires:64572},
  {year:2019,dow:"чт",label:"2019 чт",fires:64644},
  {year:2019,dow:"пт",label:"2019 пт",fires:65180},
  {year:2019,dow:"сб",label:"2019 сб",fires:73216},
  {year:2019,dow:"вскр",label:"2019 вскр",fires:73671},

  {year:2020,dow:"пн",label:"2020 пн",fires:61291},
  {year:2020,dow:"вт",label:"2020 вт",fires:58590},
  {year:2020,dow:"ср",label:"2020 ср",fires:60495},
  {year:2020,dow:"чт",label:"2020 чт",fires:61158},
  {year:2020,dow:"пт",label:"2020 пт",fires:60283},
  {year:2020,dow:"сб",label:"2020 сб",fires:68270},
  {year:2020,dow:"вскр",label:"2020 вскр",fires:69219},

  {year:2021,dow:"пн",label:"2021 пн",fires:56024},
  {year:2021,dow:"вт",label:"2021 вт",fires:53725},
  {year:2021,dow:"ср",label:"2021 ср",fires:52014},
  {year:2021,dow:"чт",label:"2021 чт",fires:51877},
  {year:2021,dow:"пт",label:"2021 пт",fires:55242},
  {year:2021,dow:"сб",label:"2021 сб",fires:60697},
  {year:2021,dow:"вскр",label:"2021 вскр",fires:61185},
];

function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function randInt(rng,n){return Math.floor(rng()*n);}

function section1SeriesForVariant(v){
  const base = SECTION1_BASE.map(o=>({...o}));
  if(v===1) return base;

  // детерминированный шум по варианту (чтобы у каждого варианта был "свой" ряд)
  const rng = mulberry32(910000 + v*104729);
  const yearScale = {
    2019: 0.97 + 0.06*rng(), // 0.97..1.03
    2020: 0.97 + 0.06*rng(),
    2021: 0.97 + 0.06*rng(),
  };

  return base.map(d=>{
    const s = yearScale[d.year];
    const dayNoise = 1 + (rng()-0.5)*0.06; // ±3%
    const val = d.fires * s * dayNoise;
    return {...d, fires: val};
  });
}

/* ===== Конфиги вариантов (разделы 2–3) ===== */
const VARIANT_CONFIGS = [{"variant": 1, "totalCalls": 300, "hotspot": 0, "meanT0": 44.2, "meanT1": 0.34, "meanT2": 0.5, "meanT3": 6.5, "seed2": 107919, "seed3": 304729}, {"variant": 2, "totalCalls": 305, "hotspot": 0, "meanT0": 41.8, "meanT1": 0.43, "meanT2": 0.3, "meanT3": 7.5, "seed2": 115838, "seed3": 409458}, {"variant": 3, "totalCalls": 310, "hotspot": 1, "meanT0": 46.0, "meanT1": 0.52, "meanT2": 0.5, "meanT3": 5.5, "seed2": 123757, "seed3": 514187}, {"variant": 4, "totalCalls": 315, "hotspot": 0, "meanT0": 43.6, "meanT1": 0.31, "meanT2": 0.3, "meanT3": 6.5, "seed2": 131676, "seed3": 618916}, {"variant": 5, "totalCalls": 320, "hotspot": 0, "meanT0": 41.2, "meanT1": 0.4, "meanT2": 0.5, "meanT3": 7.5, "seed2": 139595, "seed3": 723645}, {"variant": 6, "totalCalls": 325, "hotspot": 1, "meanT0": 45.4, "meanT1": 0.49, "meanT2": 0.3, "meanT3": 5.5, "seed2": 147514, "seed3": 828374}, {"variant": 7, "totalCalls": 330, "hotspot": 0, "meanT0": 43.0, "meanT1": 0.28, "meanT2": 0.5, "meanT3": 6.5, "seed2": 155433, "seed3": 933103}, {"variant": 8, "totalCalls": 335, "hotspot": 0, "meanT0": 40.6, "meanT1": 0.37, "meanT2": 0.3, "meanT3": 7.5, "seed2": 163352, "seed3": 1037832}, {"variant": 9, "totalCalls": 340, "hotspot": 1, "meanT0": 44.8, "meanT1": 0.46, "meanT2": 0.5, "meanT3": 5.5, "seed2": 171271, "seed3": 1142561}, {"variant": 10, "totalCalls": 345, "hotspot": 0, "meanT0": 42.4, "meanT1": 0.25, "meanT2": 0.3, "meanT3": 6.5, "seed2": 179190, "seed3": 1247290}, {"variant": 11, "totalCalls": 350, "hotspot": 0, "meanT0": 40.0, "meanT1": 0.34, "meanT2": 0.5, "meanT3": 7.5, "seed2": 187109, "seed3": 1352019}, {"variant": 12, "totalCalls": 355, "hotspot": 1, "meanT0": 44.2, "meanT1": 0.43, "meanT2": 0.3, "meanT3": 5.5, "seed2": 195028, "seed3": 1456748}, {"variant": 13, "totalCalls": 360, "hotspot": 0, "meanT0": 41.8, "meanT1": 0.52, "meanT2": 0.5, "meanT3": 6.5, "seed2": 202947, "seed3": 1561477}, {"variant": 14, "totalCalls": 365, "hotspot": 0, "meanT0": 46.0, "meanT1": 0.31, "meanT2": 0.3, "meanT3": 7.5, "seed2": 210866, "seed3": 1666206}, {"variant": 15, "totalCalls": 370, "hotspot": 1, "meanT0": 43.6, "meanT1": 0.4, "meanT2": 0.5, "meanT3": 5.5, "seed2": 218785, "seed3": 1770935}, {"variant": 16, "totalCalls": 375, "hotspot": 0, "meanT0": 41.2, "meanT1": 0.49, "meanT2": 0.3, "meanT3": 6.5, "seed2": 226704, "seed3": 1875664}, {"variant": 17, "totalCalls": 380, "hotspot": 0, "meanT0": 45.4, "meanT1": 0.28, "meanT2": 0.5, "meanT3": 7.5, "seed2": 234623, "seed3": 1980393}, {"variant": 18, "totalCalls": 385, "hotspot": 1, "meanT0": 43.0, "meanT1": 0.37, "meanT2": 0.3, "meanT3": 5.5, "seed2": 242542, "seed3": 2085122}, {"variant": 19, "totalCalls": 390, "hotspot": 0, "meanT0": 40.6, "meanT1": 0.46, "meanT2": 0.5, "meanT3": 6.5, "seed2": 250461, "seed3": 2189851}, {"variant": 20, "totalCalls": 395, "hotspot": 0, "meanT0": 44.8, "meanT1": 0.25, "meanT2": 0.3, "meanT3": 7.5, "seed2": 258380, "seed3": 2294580}, {"variant": 21, "totalCalls": 400, "hotspot": 1, "meanT0": 42.4, "meanT1": 0.34, "meanT2": 0.5, "meanT3": 5.5, "seed2": 266299, "seed3": 2399309}, {"variant": 22, "totalCalls": 405, "hotspot": 0, "meanT0": 40.0, "meanT1": 0.43, "meanT2": 0.3, "meanT3": 6.5, "seed2": 274218, "seed3": 2504038}, {"variant": 23, "totalCalls": 410, "hotspot": 0, "meanT0": 44.2, "meanT1": 0.52, "meanT2": 0.5, "meanT3": 7.5, "seed2": 282137, "seed3": 2608767}, {"variant": 24, "totalCalls": 415, "hotspot": 1, "meanT0": 41.8, "meanT1": 0.31, "meanT2": 0.3, "meanT3": 5.5, "seed2": 290056, "seed3": 2713496}, {"variant": 25, "totalCalls": 420, "hotspot": 0, "meanT0": 46.0, "meanT1": 0.4, "meanT2": 0.5, "meanT3": 6.5, "seed2": 297975, "seed3": 2818225}, {"variant": 26, "totalCalls": 425, "hotspot": 0, "meanT0": 43.6, "meanT1": 0.49, "meanT2": 0.3, "meanT3": 7.5, "seed2": 305894, "seed3": 2922954}, {"variant": 27, "totalCalls": 430, "hotspot": 1, "meanT0": 41.2, "meanT1": 0.28, "meanT2": 0.5, "meanT3": 5.5, "seed2": 313813, "seed3": 3027683}, {"variant": 28, "totalCalls": 435, "hotspot": 0, "meanT0": 45.4, "meanT1": 0.37, "meanT2": 0.3, "meanT3": 6.5, "seed2": 321732, "seed3": 3132412}, {"variant": 29, "totalCalls": 440, "hotspot": 0, "meanT0": 43.0, "meanT1": 0.46, "meanT2": 0.5, "meanT3": 7.5, "seed2": 329651, "seed3": 3237141}, {"variant": 30, "totalCalls": 445, "hotspot": 1, "meanT0": 40.6, "meanT1": 0.25, "meanT2": 0.3, "meanT3": 5.5, "seed2": 337570, "seed3": 3341870}];

/* ===== Вспомогательные функции ===== */
function downloadText(filename, text){
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function tableToCSV(table){
  const rows=[...table.querySelectorAll("tr")].map(tr=>[...tr.querySelectorAll("th,td")].map(td=>{
    let s=(td.innerText||"").replace(/\s+/g," ").trim();
    if(s.includes(",")||s.includes(";")||s.includes("\"")) s="\"" + s.replace(/"/g,'""') + "\"";
    return s;
  }).join(";"));
  return rows.join("\n");
}
function renderTable(container, headers, rows){
  let html='<table><thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';
  for(const r of rows){ html+='<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>'; }
  html+='</tbody></table>';
  container.innerHTML=html;
  return container.querySelector('table');
}
function autocorr(x, maxLag){
  const n=x.length;
  const mean=x.reduce((a,b)=>a+b,0)/n;
  const dev=x.map(v=>v-mean);
  const denom=dev.reduce((a,b)=>a+b*b,0);
  const out=[];
  for(let lag=0;lag<=maxLag;lag++){
    let num=0;
    for(let t=lag;t<n;t++) num+=dev[t]*dev[t-lag];
    out.push(num/denom);
  }
  return out;
}

/* ===== Раздел 2 ===== */
function genGridCounts(rng,totalCalls,hotspot=false){
  const cells=100;
  const counts=new Array(cells).fill(0);
  if(!hotspot){
    for(let i=0;i<totalCalls;i++) counts[randInt(rng,cells)]++;
  }else{
    const weights=new Array(cells).fill(1);
    const hot=[22,23,32,33,44,45,54,55,77,78];
    hot.forEach(i=>weights[i]=5);
    const sumW=weights.reduce((a,b)=>a+b,0);
    const cdf=[]; let acc=0;
    for(let i=0;i<cells;i++){ acc+=weights[i]/sumW; cdf.push(acc); }
    for(let i=0;i<totalCalls;i++){
      const u=rng();
      let idx=cdf.findIndex(v=>v>=u); if(idx<0) idx=cells-1;
      counts[idx]++;
    }
  }
  return counts;
}
function freqFromCounts(counts){
  const freq=new Map();
  for(const c of counts) freq.set(c,(freq.get(c)||0)+1);
  const ks=[...freq.keys()].sort((a,b)=>a-b);
  return ks.map(k=>({k, cells:freq.get(k)}));
}

/* ===== Раздел 3 ===== */
const FACT=[1];
for(let i=1;i<=60;i++) FACT[i]=FACT[i-1]*i;

function erlangCDF(t,k,lambda){
  if(!isFinite(t)) return 1.0;
  if(t<=0) return 0.0;
  const lt=lambda*t;
  let s=0;
  for(let j=0;j<=k-1;j++) s += Math.pow(lt,j)/FACT[j];
  return 1 - Math.exp(-lt)*s;
}
function sampleExponential(rng, lambda){
  let u=rng(); if(u<=0) u=1e-12;
  return -Math.log(u)/lambda;
}
function sampleErlang(rng,k,lambda){
  let s=0; for(let i=0;i<k;i++) s += sampleExponential(rng,lambda);
  return s;
}
function sampleErlangTruncated(rng,k,lambda,tmax){
  for(let tries=0;tries<10000;tries++){
    const x=sampleErlang(rng,k,lambda);
    if(x<=tmax) return x;
  }
  return tmax;
}
function makeIntervals(bounds){
  const intervals=[]; for(let i=0;i<bounds.length-1;i++) intervals.push({a:bounds[i], b:bounds[i+1]});
  return intervals;
}
function countInIntervals(values, intervals){
  const O=new Array(intervals.length).fill(0);
  for(const v of values){
    for(let i=0;i<intervals.length;i++){
      const it=intervals[i];
      const last=(i===intervals.length-1);
      if(last){ if(v>=it.a && v<=it.b){ O[i]++; break; } }
      else { if(v>=it.a && v<it.b){ O[i]++; break; } }
    }
  }
  return O;
}

/* ===== UI: варианты ===== */
const sel=document.getElementById('variantTop');
const grid=document.getElementById('variantGrid');

for(let i=1;i<=30;i++){
  const opt=document.createElement('option');
  opt.value=String(i); opt.textContent=String(i);
  sel.appendChild(opt);

  const b=document.createElement('button');
  b.className='variant-btn';
  b.type='button';
  b.textContent=String(i);
  b.addEventListener('click', ()=>setVariant(i));
  grid.appendChild(b);
}
function markActive(v){
  [...grid.querySelectorAll('.variant-btn')].forEach((btn,idx)=>{
    btn.classList.toggle('active', (idx+1)===v);
  });
}

/* ===== Экспорт CSV ===== */
let csv1="", csv2grid="", csv2freq="", csv3="";

/* ===== Построение разделов ===== */
function buildSection1(v){
  const series = section1SeriesForVariant(v);
  const rows=series.map((d,i)=>[i+1, d.label, Math.round(d.fires)]);
  const t=renderTable(document.getElementById('s1out'), ['№','Период','Количество пожаров'], rows);
  csv1 = tableToCSV(t);

  // (в режиме слушателя автокорреляцию не показываем)
  if(false){
    const x=series.map(d=>d.fires);
    const acf=autocorr(x,10);
    renderTable(document.getElementById('s1acfTable'), ['Лаг','r(лаг)'], acf.map((r,lag)=>[lag, r.toFixed(4)]));
  }
}

function buildSection2(cfg){
  const rng=mulberry32(cfg.seed2);
  const counts=genGridCounts(rng, cfg.totalCalls, cfg.hotspot===1);
  const gridRows=[];
  for(let r=0;r<10;r++){
    const row=[];
    for(let c=0;c<10;c++) row.push(counts[r*10+c]);
    gridRows.push(row);
  }
  const gridTable=renderTable(document.getElementById('s2grid'), [...Array(10)].map((_,i)=>'C'+(i+1)), gridRows);
  csv2grid = tableToCSV(gridTable);

  const freq=freqFromCounts(counts);
  const freqTable=renderTable(document.getElementById('s2freq'), ['k','Число участков'], freq.map(o=>[o.k,o.cells]));
  csv2freq = tableToCSV(freqTable);

  const lambda = cfg.totalCalls/100;
  document.getElementById('s2kpi').innerHTML = `
    <div class="pill"><small>Всего выездов</small><b>${cfg.totalCalls}</b></div>
    <div class="pill"><small>Участков</small><b>100</b></div>
    <div class="pill"><small>λ = N/100</small><b>${lambda.toFixed(3)}</b></div>
    <div class="pill"><small>Сценарий</small><b>${cfg.hotspot===1?'горячие зоны':'равномерно'}</b></div>
  `;
}

function buildSection3(cfg){
  const N=100;
  const rng=mulberry32(cfg.seed3);

  const k0=1,k1=2,k2=3,k3=4;
  const lam0=k0/cfg.meanT0, lam1=k1/cfg.meanT1, lam2=k2/cfg.meanT2, lam3=k3/cfg.meanT3;

  const Tmax1=1.0, Tmax2=1.0, Tmax3=10.0;

  const T0=[...Array(N)].map(()=>sampleErlang(rng,k0,lam0));
  const T1=[...Array(N)].map(()=>sampleErlangTruncated(rng,k1,lam1,Tmax1));
  const T2=[...Array(N)].map(()=>sampleErlangTruncated(rng,k2,lam2,Tmax2));
  const T3=[...Array(N)].map(()=>sampleErlangTruncated(rng,k3,lam3,Tmax3));

  const I0=makeIntervals([0,15,30,45,60,90,Infinity]);
  const I1=makeIntervals([0,0.15,0.25,0.35,0.45,0.55,1.0]);
  const I2=makeIntervals([0,0.205,0.305,0.414,0.571,0.710,1.0]);
  const I3=makeIntervals([0,3.0,4.0,5.5,7.0,8.5,10.0]);

  const tables=[
    {key:'T0', name:'T₀ — обслуживание вызова, мин', values:T0, intervals:I0, tmax:null},
    {key:'T1', name:'T₁ — диспетчеризация, мин (≤1)', values:T1, intervals:I1, tmax:Tmax1},
    {key:'T2', name:'T₂ — сбор и выезд, мин (≤1)', values:T2, intervals:I2, tmax:Tmax2},
    {key:'T3', name:'T₃ — следование, мин (≤10)', values:T3, intervals:I3, tmax:Tmax3},
  ];

  const out=document.getElementById('s3out');
  out.innerHTML='';
  const csvLines=['Показатель;Интервал;O_i'];
  const fmtInt=(a,b,last)=>!isFinite(b)?`[${a};∞)`:`[${a};${b}${last?']':')'}`;

  for(const t of tables){
    const O=countInIntervals(t.values, t.intervals);
    const rows=t.intervals.map((it,idx)=>[fmtInt(it.a,it.b,idx===t.intervals.length-1), O[idx]]);
    const box=document.createElement('div');
    box.className='card'; box.style.background='rgba(0,0,0,.12)'; box.style.borderColor='rgba(255,255,255,.08)';
    box.innerHTML=`<h4 style="margin:0 0 6px 0;">${t.name}: интервалы и эмпирические частоты Oᵢ</h4><div id="tbl_${t.key}"></div>`;
    out.appendChild(box);
    renderTable(box.querySelector(`#tbl_${t.key}`), ['Интервал','Oᵢ'], rows);
    rows.forEach(r=>csvLines.push(`${t.name};${r[0]};${r[1]}`));
  }
  csv3 = csvLines.join("\n");

  document.getElementById('s3kpi').innerHTML = `
    <div class="pill"><small>N</small><b>100</b></div>
    <div class="pill"><small>Среднее T₀</small><b>${cfg.meanT0}</b></div>
    <div class="pill"><small>Среднее T₁</small><b>${cfg.meanT1}</b></div>
    <div class="pill"><small>Среднее T₂</small><b>${cfg.meanT2}</b></div>
    <div class="pill"><small>Среднее T₃</small><b>${cfg.meanT3}</b></div>
  `;
}

function buildKit(){
  const v=parseInt(sel.value,10);
  document.getElementById('curVar').textContent=String(v);
  document.getElementById('printVar').textContent=String(v);
  markActive(v);

  const cfg=VARIANT_CONFIGS.find(x=>Number(x.variant)===v);
  if(!cfg){ alert('Не найден конфиг для варианта '+v); return; }

  buildSection1(v);
  buildSection2(cfg);
  buildSection3(cfg);
}

function setVariant(v){
  sel.value=String(v);
  buildKit();
}

/* ===== События ===== */
document.getElementById('btnKit').addEventListener('click', buildKit);
sel.addEventListener('change', buildKit);
sel.addEventListener('input', buildKit);

document.getElementById('btnCSV').addEventListener('click', ()=>{
  if(!csv1) buildKit();
  downloadText(`Вариант_${sel.value}_Раздел1_Ряд.csv`, csv1);
  downloadText(`Вариант_${sel.value}_Раздел2_Матрица_10x10.csv`, csv2grid);
  downloadText(`Вариант_${sel.value}_Раздел2_Частоты.csv`, csv2freq);
  downloadText(`Вариант_${sel.value}_Раздел3_Oi.csv`, csv3);
});

document.getElementById('btnPrint').addEventListener('click', ()=>{
  if(!csv1) buildKit();
  const d = new Date();
  document.getElementById('printDate').textContent = d.toLocaleString('ru-RU');
  window.print();
});

setVariant(1);
</script>
</body>
</html>
